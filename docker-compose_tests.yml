version: '3.0'
services:
  corestub:
    build:
      context: .
      dockerfile: api/Dockerfile-corestub
    environment:
      - SC_GRPC_HOST_ADDR=0.0.0.0:10000
      - LOCAL_SURFACE_PATH=/tmp/fixtures/surfaces
    volumes:
      - fixture_vol:/tmp/fixtures

  auth:
    image: lambdaville/no-factor-auth:v0.0.5
    # ports:
    #   - '8089:8089'

  api:
    build:
      context: .
      dockerfile: api/Dockerfile
    depends_on:
      - corestub
      - auth
    environment:
      - API_SECRET="12345678"
      - HTTP_ONLY=true
      - HOST_ADDR=0.0.0.0:8080
      - STITCH_GRPC_ADDR=corestub:10000
      - MANIFEST_PATH=/tmp/fixtures/manifests
      - LOCAL_SURFACE_PATH=/tmp/fixtures/surfaces
      - AUTHSERVER=http://auth:8089/common
      - ISSUER=auth:8089
    volumes:
      - fixture_vol:/tmp/fixtures

  test:
    build:
      context: tests/integration
    depends_on:
      - api
    environment:
      - SC_API_HOST_ADDR=http://api:8080
      - FIXTURES_PATH=/tmp/fixtures
      - AUTH_ADDR=http://auth:8089/common
    volumes:
      - fixture_vol:/tmp/fixtures
volumes:
  fixture_vol:
    driver_opts:
      type: tmpfs
      device: tmpfs
