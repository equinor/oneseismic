trigger:
  - master
  - release

jobs:
  - job: Test_Ingestion
    steps:
      - script: |
          docker-compose up --build --exit-code-from int_tests
        displayName: 'Test Ingestion'
        workingDirectory: core/ingestion

  - job: build_test_push
    steps:
      - script: |
          sudo curl -L "https://github.com/docker/compose/releases/download/1.25.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
        displayName: Upgrade docker compose
      - script: |
          export VERSION=`git describe --tags`
          docker-compose build
        displayName: 'Build docker images'
      - script: |
          docker-compose -f docker-compose_tests.yml up --build --exit-code-from test
        displayName: 'Run integration tests'
      - script: |
          export VERSION=`git describe --tags`
          echo $(ACRPASSWD)|docker login -u lambdaville lambdaville.azurecr.io --password-stdin
          docker-compose push
        condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
        displayName: 'Push docker images'

schedules:
  - cron: '0 6 * * *'
    displayName: nightly build
    branches:
      include:
        - master
    always: true
